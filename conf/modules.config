/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    //
    // ROSE2 super-enhancer calling
    //
    withName: ROSE2 {
        publishDir = [
            path: { "${params.outdir}/rose2" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: ROSE_TO_BEDS {
        publishDir = [
            path: { "${params.outdir}/rose2/beds" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // deepTools visualization
    //
    withName: 'DEEPTOOLS_BAMCOVERAGE' {
        ext.args = '--binSize 10 --normalizeUsing CPM'
        publishDir = [
            path: { "${params.outdir}/visualization/bigwigs" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DEEPTOOLS_COMPUTEMATRIX' {
        ext.args = 'scale-regions -b 3000 -a 3000 --regionBodyLength 5000 --skipZeros'
        publishDir = [
            path: { "${params.outdir}/visualization/matrices" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DEEPTOOLS_PLOTHEATMAP' {
        ext.args = '--colorMap RdYlBu --whatToShow "heatmap and colorbar"'
        publishDir = [
            path: { "${params.outdir}/visualization/heatmaps" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DEEPTOOLS_PLOTPROFILE' {
        ext.args = '--perGroup --colors red blue green'
        publishDir = [
            path: { "${params.outdir}/visualization/profiles" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DEEPTOOLS_PLOTFINGERPRINT' {
        publishDir = [
            path: { "${params.outdir}/visualization/fingerprints" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // HOMER motif analysis
    //
    withName: 'HOMER_FINDMOTIFSGENOME_SE' {
        ext.args = '-mask'
        publishDir = [
            path: { "${params.outdir}/motif_analysis/homer/super_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'HOMER_FINDMOTIFSGENOME_TE' {
        ext.args = '-mask'
        publishDir = [
            path: { "${params.outdir}/motif_analysis/homer/typical_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'HOMER_ANNOTATEPEAKS' {
        publishDir = [
            path: { "${params.outdir}/motif_analysis/homer/annotations" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // BEDTools getfasta for motif analysis
    //
    withName: 'GETFASTA_SE' {
        publishDir = [
            path: { "${params.outdir}/motif_analysis/fasta" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'GETFASTA_TE' {
        publishDir = [
            path: { "${params.outdir}/motif_analysis/fasta" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // FIMO motif scanning
    //
    withName: 'FIMO_SE' {
        ext.args = '--thresh 1e-4'
        publishDir = [
            path: { "${params.outdir}/motif_analysis/fimo/super_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'FIMO_TE' {
        ext.args = '--thresh 1e-4'
        publishDir = [
            path: { "${params.outdir}/motif_analysis/fimo/typical_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // SEA simple enrichment analysis
    //
    withName: 'SEA_SE' {
        publishDir = [
            path: { "${params.outdir}/motif_analysis/sea/super_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'SEA_TE' {
        publishDir = [
            path: { "${params.outdir}/motif_analysis/sea/typical_enhancers" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // CRC analysis with Coltron
    //
    withName: COLTRON {
        publishDir = [
            path: { "${params.outdir}/crc_analysis" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // Functional annotation with rGREAT
    //
    withName: RGREAT {
        publishDir = [
            path: { "${params.outdir}/functional_annotation/rgreat" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // Cross-condition comparison with intervene
    //
    withName: 'COMPARISON:INTERVENE_INDIVIDUAL' {
        publishDir = [
            path: { "${params.outdir}/comparison/individual_samples" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'COMPARISON:INTERVENE_CONDITIONS' {
        publishDir = [
            path: { "${params.outdir}/comparison/merged_conditions" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // deepTools comparison modules
    //
    withName: 'COMPARISON:DEEPTOOLS_PLOTCORRELATION' {
        ext.args = '--corMethod pearson --whatToPlot heatmap --plotNumbers'
        publishDir = [
            path: { "${params.outdir}/comparison/deeptools" },
            mode: params.publish_dir_mode,
            pattern: '*.{pdf,tab}'
        ]
    }

    withName: 'COMPARISON:DEEPTOOLS_COMPUTEMATRIX' {
        ext.args = 'scale-regions -b 5000 -a 5000 --regionBodyLength 10000 --skipZeros'
        publishDir = [
            path: { "${params.outdir}/comparison/deeptools" },
            mode: params.publish_dir_mode,
            pattern: '*.mat.gz'
        ]
    }

    withName: 'COMPARISON:DEEPTOOLS_PLOTHEATMAP' {
        ext.args = '--colorMap RdYlBu --whatToShow "heatmap and colorbar" --plotTitle "Super-Enhancer Signal Across Conditions"'
        publishDir = [
            path: { "${params.outdir}/comparison/deeptools" },
            mode: params.publish_dir_mode,
            pattern: '*.pdf'
        ]
    }

    withName: 'COMPARISON:DEEPTOOLS_PLOTPROFILE' {
        ext.args = '--plotTitle "Super-Enhancer Signal Profile" --perGroup'
        publishDir = [
            path: { "${params.outdir}/comparison/deeptools" },
            mode: params.publish_dir_mode,
            pattern: '*.pdf'
        ]
    }

    //
    // BEDTools merge for comparison
    //
    withName: 'COMPARISON:MERGE_BY_CONDITION' {
        ext.prefix = { "${meta.id}_merged" }
        publishDir = [
            path: { "${params.outdir}/comparison/merged_beds" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'COMPARISON:MERGE_ALL_SES' {
        ext.prefix = { "${meta.id}_merged" }
        publishDir = [
            path: { "${params.outdir}/comparison/merged_beds" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'COMPARISON:MERGE_ALL_TES' {
        ext.prefix = { "${meta.id}_merged" }
        publishDir = [
            path: { "${params.outdir}/comparison/merged_beds" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // MultiQC reporting
    //
    withName: 'MULTIQC' {
        ext.args   = { params.multiqc_title ? "--title \"$params.multiqc_title\"" : '' }
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    //
    // Design summary generation
    //
    withName: GENERATE_DESIGN_SUMMARY {
        publishDir = [
            path: { "${params.outdir}/design" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

}
